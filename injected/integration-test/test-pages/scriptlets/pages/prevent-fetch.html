<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Prevent Fetch Scriptlet Test</title>
    <link rel="stylesheet" href="../../shared/style.css">
</head>
<body>
    <script src="../../shared/utils.js"></script>
    <p><a href="../index.html">[Scriptlets]</a></p>

    <p>This page verifies that the prevent-fetch scriptlet works properly given the <a href="../config/prevent-fetch.json">config</a>.</p>

    <script>
        // eslint-disable-next-line no-undef
        test('Prevent-fetch scriptlet should block matching fetch requests', async () => {
            // Wait a bit for scriptlets to execute
            await new Promise(resolve => setTimeout(resolve, 100));

            let blockedFetchResult = null;
            let blockedFetchError = null;
            let allowedFetchResult = null;
            let allowedFetchError = null;

            // Try to fetch a blocked URL (should be blocked - contains "blocked-url")
            try {
                blockedFetchResult = await fetch('https://example.com/blocked-url');
            } catch (error) {
                blockedFetchError = error;
            }

            // Try to fetch an allowed URL (should fail due to CORS but attempt should be made)
            try {
                allowedFetchResult = await fetch('https://example.com/allowed-url');
            } catch (error) {
                allowedFetchError = error;
            }

            // The scriptlet works by:
            // 1. Blocked URL gets intercepted and returns a mock Response object
            // 2. Allowed URL fails normally with network/CORS errors
            const blockedRequestIntercepted = blockedFetchResult !== null && blockedFetchError === null;
            const allowedRequestFailedNormally = allowedFetchResult === null && allowedFetchError !== null;

            return [
                { name: 'fetch function should still exist', result: typeof fetch, expected: 'function' },
                { name: 'Blocked fetch should return mock response', result: blockedRequestIntercepted, expected: true },
                { name: 'Allowed fetch should fail with network error', result: allowedRequestFailedNormally, expected: true }
            ];
        });

        // eslint-disable-next-line no-undef
        renderResults();
    </script>
</body>
</html> 