<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Trusted Set Cookie Scriptlet Test</title>
    <link rel="stylesheet" href="../../shared/style.css">
</head>
<body>
    <script src="../../shared/utils.js"></script>
    <p><a href="../index.html">[Scriptlets]</a></p>

    <p>This page verifies that the trusted-set-cookie scriptlet works properly given the <a href="../config/trusted-set-cookie.json">config</a>.</p>

    <script>
        // Helper function to check if a cookie exists
        function hasCookie(name) {
            return document.cookie.split(';').some(c => {
                return c.trim().startsWith(name + '=');
            });
        }

        // Helper function to get cookie value
        function getCookieValue(name) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [cookieName, cookieValue] = cookie.trim().split('=');
                if (cookieName === name) {
                    return cookieValue;
                }
            }
            return null;
        }

        // eslint-disable-next-line no-undef
        test('Trusted-set-cookie scriptlet should set cookies with special values', async () => {
            // Wait a bit for scriptlets to execute
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const hasTrustedCookie = hasCookie('trustedCookie');
            const trustedCookieValue = getCookieValue('trustedCookie');
            const hasTimestampCookie = hasCookie('timestampCookie');
            const timestampCookieValue = getCookieValue('timestampCookie');

            // Check if timestamp cookie has a reasonable timestamp value
            const timestampValue = parseInt(timestampCookieValue);
            const currentTime = Date.now();
            const isReasonableTimestamp = timestampValue > (currentTime - 60000) && timestampValue <= currentTime; // Within last minute

            return [
                { name: 'trustedCookie should be set', result: hasTrustedCookie, expected: true },
                { name: 'trustedCookie should have correct value', result: trustedCookieValue, expected: 'trustedValue' },
                { name: 'timestampCookie should be set', result: hasTimestampCookie, expected: true },
                { name: 'timestampCookie should have reasonable timestamp value', result: isReasonableTimestamp, expected: true }
            ];
        });

        // eslint-disable-next-line no-undef
        renderResults();
    </script>
</body>
</html> 